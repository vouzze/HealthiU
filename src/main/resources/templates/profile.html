<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <link th:href="@{/webjars/bootstrap/css/bootstrap.min.css}" rel="stylesheet" type="text/css">
    <link th:href="@{/css/style.css}" rel="stylesheet" type="text/css">
    <title>Edit Profile!</title>
</head>
<body>
<h1 th:inline="text">Hello [[${role}]] [[${#httpServletRequest.remoteUser}]]!</h1>
<div th:if="${role == 'ADMIN'}">Text visible to admin.</div>

<form id="edit_form" th:action="@{/profile/edit}" th:object="${userData}" method="post">
    <div><label> Login : <input id="login_edit" type="text" th:field="*{login}" th:value="${login}" name="login"
                                readonly/> </label>
    </div>
    <div><label> Name : <input id="name_edit" type="text" th:field="*{name}" th:value="${name}" name="name"/> </label>
        <div id="error_name_edit"></div>
    </div>
    <div><label> Email : <input id="email_edit" type="text" th:field="*{email}" th:value="${email}" name="email"/> </label>
        <div id="error_email_edit"></div>
    </div>
    <div><label> Password: <input id="password_edit" type="password" th:field="*{password}" name="password"/> </label>
        <div id="error_password_edit"></div>
    </div>
    <div><label> Confirm Password: <input id="confirm_password_edit" type="password" th:field="*{confirmPassword}"
                                          name="confirm_password"/> </label>
        <div id="error_confirm_password_edit"></div>
    </div>
    <div><label> Date of birth: <input id="date_of_birth_edit" type="date" th:field="*{dateOfBirth}" th:value="${dateOfBirth}"
                                       name="date_of_birth"/> </label>
        <div id="error_date_of_birth_edit"></div>
    </div>
    <div><input type="submit" value="Edit"/></div>
    <div id="email_exists_edit" th:text="${emailExists}"></div>
    <div id="edit_successful" th:text="${successfulEdit}"></div>
</form>

<button id="show_test" onclick="window.location.href = '/profile/test'">Show test</button>

<form th:action="@{/logout}" method="post">
    <input type="submit" value="Sign Out"/>
</form>

<script th:src="@{/webjars/jquery/jquery.min.js}"></script>
<script th:inline="javascript">
    let editForm = document.getElementById("edit_form");
    let errorNameEdit = $('#error_name_edit');
    let errorEmailEdit = $('#error_email_edit');
    let errorPasswordEdit = $('#error_password_edit');
    let errorConfirmPasswordEdit = $('#error_confirm_password_edit');
    let errorDateOfBirthEdit = $('#error_date_of_birth_edit');

    editForm.addEventListener("submit", function (e) {
        e.preventDefault();

        $('#email_exists_edit').text(null);
        $('#edit_successful').text(null);
        let errorCount = 0;

        let name = $('#name_edit').val();
        let email = $('#email_edit').val();
        let password = $('#password_edit').val();
        let confirmPassword = $('#confirm_password_edit').val();
        let dateOfBirth = $('#date_of_birth_edit').val();

        errorNameEdit.text(null);
        errorEmailEdit.text(null);
        errorPasswordEdit.text(null);
        errorConfirmPasswordEdit.text(null);
        errorDateOfBirthEdit.text(null);

        if (!checkName(name)) {
            errorNameEdit.text("Invalid name.");
            errorCount++;
        }

        if (!checkEmail(email)) {
            errorEmailEdit.text("Invalid email.");
            errorCount++;
        }

        if (!checkPassword(password)) {
            errorPasswordEdit.text("Invalid password.");
            errorCount++;
        }

        if (!checkConfirmPassword(password, confirmPassword)) {
            errorConfirmPasswordEdit.text("Passwords don't match.");
            errorCount++;
        }

        if (!checkDateOfBirth(dateOfBirth)) {
            errorDateOfBirthEdit.text("Invalid date of birth. Only users from 14 years old are allowed.");
            errorCount++;
        }

        if (errorCount === 0) {
            editForm.submit();
        }
    })

    function checkName(name) {
        if (isEmpty(name)) {
            return false;
        }

        if (hasSpacesBeforeOrAfter(name)) {
            return false;
        }

        return !(name.length < 2 || name.length > 20);
    }

    function checkEmail(email) {
        const regex_pattern = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        return regex_pattern.test(email);
    }

    function checkPassword(password) {
        if (isEmpty(password)) {
            return true;
        }

        if (hasSpacesBeforeOrAfter(password)) {
            return false;
        }

        if (hasSpaces(password)) {
            return false;
        }

        return !(password.length < 6 || password.length > 10);
    }

    function checkConfirmPassword(password, confirmPassword) {
        return password === confirmPassword;
    }

    function checkDateOfBirth(dateOfBirth) {
        let ageDifMs = Date.now() - new Date(dateOfBirth);
        let ageDate = new Date(ageDifMs);
        return (Math.abs(ageDate.getUTCFullYear() - 1970)) >= 14;
    }

    function isEmpty(text) {
        return text.length === 0 || isSpaces(text);
    }

    function hasSpaces(text) {
        for (let i = 0; i < text.length; i++) {
            if ((text[i]) === ' ') {
                return true;
            }
        }
        return false;
    }
    function isSpaces(text) {
        return text.trim().length === 0;
    }
    function hasSpacesBeforeOrAfter(text) {
        return text.length > text.trim().length;
    }
</script>
</body>
</html>